<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å›¢é˜Ÿç©ºé—´ - å®æ—¶æ–°é—» Â· åª’ä½“ Â· æ„¿æœ›æ± </title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  body { background: linear-gradient(135deg,#0f172a 0%,#111827 100%); font-family: Inter, "Helvetica Neue", Arial, sans-serif; color:#e6eef8; }
  .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(8px); border-radius:12px; box-shadow: 0 6px 20px rgba(2,6,23,0.6); }
  .btn { transition: all .18s ease; }
  .btn:hover { transform: translateY(-2px); }
  .three-cols { display:grid; grid-template-columns: 1fr; gap:12px; }
  @media(min-width:900px){ .three-cols { grid-template-columns: 1fr 1fr 1fr; } }
  .modal {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:50;}
  .modal img,.modal video{max-width:90%;max-height:90%;border-radius:8px;}
</style>
</head>
<body class="min-h-screen">

<!-- ç™»å½•é¡µé¢ -->
<div id="loginRoot" class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md glass p-6">
    <h1 class="text-2xl font-bold mb-3 text-center">æ¬¢è¿ä½¿ç”¨ Â· å›¢é˜Ÿç©ºé—´</h1>
    <p class="text-sm text-gray-400 mb-6 text-center">å®¢æˆ·è¯·è¾“å…¥ä¸­æ–‡å§“åï¼ˆè‡³å°‘2ä¸ªå­—ï¼‰ï¼Œç®¡ç†å‘˜è¾“å…¥ guangminghui</p>
    <input id="inputName" class="w-full p-3 rounded bg-gray-900 border border-gray-800 placeholder-gray-500" placeholder="è¯·è¾“å…¥å§“å" />
    <div id="adminPassWrapper" class="mt-3 hidden">
      <input id="inputAdminPass" type="password" class="w-full p-3 rounded bg-gray-900 border border-gray-800" placeholder="ç®¡ç†å‘˜å¯†ç " />
    </div>
    <div class="mt-5 flex items-center justify-between">
      <button id="btnLogin" class="btn px-4 py-2 rounded bg-gradient-to-r from-green-500 to-teal-400 font-medium">è¿›å…¥</button>
    </div>
  </div>
</div>

<!-- ä¸»ç•Œé¢ -->
<div id="appRoot" class="hidden min-h-screen p-4">
  <header class="flex items-center justify-between mb-4">
    <div class="text-2xl font-bold">å›¢é˜Ÿæ–°é—»ç©ºé—´</div>
    <div class="flex items-center gap-3">
      <div id="onlineUsers" class="text-sm text-gray-400">åœ¨çº¿ç”¨æˆ·ï¼š0</div>
      <button id="btnLogout" class="btn px-3 py-1 bg-gray-800 rounded">é€€å‡º</button>
    </div>
  </header>

  <div class="three-cols mb-6" id="threeCols">
    <section id="colNews">
      <h2 class="text-lg mb-3">äº‘å–„ç»˜æ–°é—»</h2>
      <div id="newsList"></div>
      <div id="adminNewsForm" class="hidden mt-4">
        <textarea id="newsText" class="w-full p-2 rounded bg-gray-900 border border-gray-700" placeholder="è¾“å…¥æ–°é—»å†…å®¹"></textarea>
        <input type="file" id="newsFile" class="mt-2"/>
        <button id="btnPostNews" class="btn mt-2 px-3 py-1 bg-blue-600 rounded">å‘å¸ƒæ–°é—»</button>
      </div>
    </section>

    <section id="colMedia">
      <h2 class="text-lg mb-3">è§†é¢‘ä¸ç…§ç‰‡</h2>
      <div id="mediaGrid" class="grid grid-cols-2 gap-2"></div>
      <div id="adminMediaForm" class="hidden mt-4">
        <input type="file" id="mediaFile" />
        <button id="btnUploadMedia" class="btn mt-2 px-3 py-1 bg-green-600 rounded">ä¸Šä¼ åª’ä½“</button>
        <div id="uploadProgress" class="text-sm text-gray-400"></div>
      </div>
    </section>

    <section id="colWish">
      <h2 class="text-lg mb-3">æ„¿æœ›æ± </h2>
      <div id="wishList"></div>
      <div class="mt-3 flex gap-2">
        <input id="wishInput" class="flex-1 p-2 rounded bg-gray-900 border border-gray-700" placeholder="å†™ä¸‹ä½ çš„æ„¿æœ›..."/>
        <button id="btnWish" class="btn px-3 py-1 bg-purple-600 rounded">å‘å¸ƒ</button>
      </div>
    </section>
  </div>
  <div id="syncStatus" class="fixed bottom-2 left-2 text-sm">ğŸŸ¡ æ­£åœ¨åŒæ­¥...</div>
</div>

<div id="modal" class="modal hidden"><div id="modalContent"></div></div>

<script>
const ADMIN_NAME = "guangminghui";
const ADMIN_PASS = "guangminghui888";

const loginRoot = document.getElementById('loginRoot');
const appRoot = document.getElementById('appRoot');
const inputName = document.getElementById('inputName');
const inputAdminPass = document.getElementById('inputAdminPass');
const adminPassWrapper = document.getElementById('adminPassWrapper');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const syncStatus = document.getElementById('syncStatus');
const onlineUsers = document.getElementById('onlineUsers');

const adminNewsForm = document.getElementById('adminNewsForm');
const adminMediaForm = document.getElementById('adminMediaForm');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');

let state = { me:null, isAdmin:false };

// è¾“å…¥åˆ¤æ–­
inputName.addEventListener('input', ()=>{
  if(inputName.value.trim() === ADMIN_NAME){
    adminPassWrapper.classList.remove('hidden');
  } else {
    adminPassWrapper.classList.add('hidden');
  }
});

// ç™»å½•
btnLogin.addEventListener('click', ()=>{
  const name = inputName.value.trim();
  if(!name){ alert("è¯·è¾“å…¥åå­—"); return; }
  if(name === ADMIN_NAME){
    if(inputAdminPass.value !== ADMIN_PASS){ alert("ç®¡ç†å‘˜å¯†ç é”™è¯¯"); return; }
    state.isAdmin = true;
  } else {
    if(!/^[\u4e00-\u9fa5]{2,}$/.test(name)){ alert("å®¢æˆ·å§“åå¿…é¡»æ˜¯ä¸¤ä¸ªä»¥ä¸Šä¸­æ–‡"); return; }
    state.isAdmin = false;
  }
  state.me = name;
  loginRoot.classList.add("hidden");
  appRoot.classList.remove("hidden");
  if(state.isAdmin){ adminNewsForm.classList.remove("hidden"); adminMediaForm.classList.remove("hidden"); }
  syncData();
});

// ç™»å‡º
btnLogout.addEventListener('click', ()=>{
  loginRoot.classList.remove("hidden");
  appRoot.classList.add("hidden");
  state = { me:null, isAdmin:false };
});

// æ¨¡æ‹Ÿ fetch
async function syncData(){
  try{
    syncStatus.textContent = "ğŸŸ¡ æ­£åœ¨åŒæ­¥...";
    const r = await fetch("/data");
    const j = await r.json();
    document.getElementById('newsList').innerHTML = j.news.map(n=>`
      <div class='mb-2 p-2 bg-gray-800 rounded'>
        <div>${n.text}</div>
        ${n.file ? `<img src='${n.file}' class='mt-1 rounded cursor-pointer' onclick='showModal("img","${n.file}")'/>`: ""}
        ${state.isAdmin?`<button onclick='deleteItem("news","${n.id}")' class='text-red-400 text-sm'>åˆ é™¤</button>`:""}
      </div>`).join("");
    document.getElementById('mediaGrid').innerHTML = j.media.map(m=>`
      ${m.type.startsWith("video")?
        `<video src='${m.file}' controls class='rounded cursor-pointer' onclick='showModal("video","${m.file}")'></video>`:
        `<img src='${m.file}' class='rounded cursor-pointer' onclick='showModal("img","${m.file}")'/>`}
      ${state.isAdmin?`<button onclick='deleteItem("media","${m.id}")' class='text-red-400 text-sm'>åˆ é™¤</button>`:""}
    `).join("");
    document.getElementById('wishList').innerHTML = j.wishes.map(w=>`
      <div class='mb-2 p-2 bg-gray-800 rounded'>
        <div>${w.text}</div>
        <div class='flex gap-2 text-sm text-gray-400'>
          <button onclick='likeWish("${w.id}")'>ğŸ‘ ${w.likes||0}</button>
          ${state.isAdmin?`<button onclick='deleteItem("wish","${w.id}")' class='text-red-400'>åˆ é™¤</button>`:""}
        </div>
      </div>`).join("");
    onlineUsers.textContent = "åœ¨çº¿ç”¨æˆ·ï¼š" + (j.online||0);
    syncStatus.textContent = "ğŸŸ¢ å·²åŒæ­¥";
  }catch(e){
    syncStatus.textContent = "ğŸ”´ åŒæ­¥å¤±è´¥";
  }
  setTimeout(syncData,3000);
}

// ä¸Šä¼ æ–°é—»
document.getElementById('btnPostNews').onclick=async()=>{
  const text=document.getElementById('newsText').value;
  const file=document.getElementById('newsFile').files[0];
  let fileUrl="";
  if(file){
    const form=new FormData(); form.append("file",file);
    const res=await fetch("/upload",{method:"POST",body:form});
    const j=await res.json(); fileUrl=j.file;
  }
  await fetch("/news",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:Date.now(),text,file:fileUrl,adminName:ADMIN_NAME,adminPass:ADMIN_PASS})});
  document.getElementById('newsText').value="";
  document.getElementById('newsFile').value="";
};

// ä¸Šä¼ åª’ä½“
document.getElementById('btnUploadMedia').onclick=async()=>{
  const file=document.getElementById('mediaFile').files[0];
  if(!file) return;
  const form=new FormData(); form.append("file",file);
  const xhr=new XMLHttpRequest();
  xhr.upload.onprogress=(e)=>{ if(e.lengthComputable){ document.getElementById('uploadProgress').textContent=`${(e.loaded/e.total*100).toFixed(1)}%`; }};
  xhr.onload=()=>{ document.getElementById('uploadProgress').textContent="å®Œæˆ"; };
  xhr.open("POST","/upload"); xhr.send(form);
};

// æ„¿æœ›
document.getElementById('btnWish').onclick=async()=>{
  const text=document.getElementById('wishInput').value;
  if(!text) return;
  await fetch("/wish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:Date.now(),text,user:state.me})});
  document.getElementById('wishInput').value="";
};

// åˆ é™¤
async function deleteItem(type,id){
  await fetch("/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type,id,adminName:ADMIN_NAME,adminPass:ADMIN_PASS})});
}

// ç‚¹èµ
async function likeWish(id){
  await fetch("/like",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id})});
}

// å¼¹çª—é¢„è§ˆ
function showModal(type,src){
  modal.classList.remove("hidden");
  modalContent.innerHTML = type==="img"?`<img src='${src}'/>`:`<video src='${src}' controls autoplay></video>`;
}
modal.onclick=()=>{ modal.classList.add("hidden"); modalContent.innerHTML=""; }
</script>
</body>
</html>