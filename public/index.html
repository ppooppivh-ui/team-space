<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›¢é˜Ÿç©ºé—´</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #4f46e5, #9333ea); min-height: 100vh; display:flex; align-items:center; justify-content:center; }
    .glass {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
    .hidden { display: none; }
    #status { position: fixed; bottom: 10px; left: 10px; font-size: 14px; }
    .like { cursor: pointer; transition: transform 0.2s; }
    .like:active { transform: scale(1.3); }
    #previewModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; }
    #previewModal img, #previewModal video { max-width: 90%; max-height: 90%; border-radius: 12px; }
  </style>
</head>
<body>

<!-- ç™»å½•é¡µï¼ˆç¼©å°ç‰ˆï¼‰ -->
<div id="loginPage" class="glass w-full max-w-xs p-6 mx-4">
  <h2 class="text-xl font-bold mb-4 text-center text-white">ç™»å½•å›¢é˜Ÿç©ºé—´</h2>
  <input id="username" type="text" placeholder="è¯·è¾“å…¥åå­—" class="border border-gray-300 p-2 w-full mb-3 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none"/>
  <div id="adminPassDiv" class="hidden">
    <input id="adminPass" type="password" placeholder="ç®¡ç†å‘˜å¯†ç " class="border border-gray-300 p-2 w-full mb-3 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none"/>
  </div>
  <button id="loginBtn" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-2 rounded-lg shadow hover:opacity-90 transition">è¿›å…¥</button>
</div>

<!-- ä¸»é¡µé¢ -->
<div id="mainPage" class="hidden p-4 w-full">
  <header class="flex justify-between items-center p-4 bg-white shadow mb-4 rounded-lg">
    <h1 class="text-xl font-bold">å›¢é˜Ÿæ–°é—»ç©ºé—´</h1>
    <button id="logoutBtn" class="px-3 py-1 bg-gray-200 rounded">é€€å‡º</button>
  </header>

  <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="contentArea"></main>

  <div class="fixed bottom-4 right-4 space-x-2">
    <button id="newNews" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg shadow">å‘å¸ƒæ–°é—»</button>
    <button id="newWish" class="bg-purple-600 text-white px-4 py-2 rounded-lg shadow">è®¸æ„¿</button>
    <input type="file" id="fileInput" multiple class="hidden"/>
    <button id="uploadBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow">ä¸Šä¼ </button>
  </div>

  <div id="progressContainer" class="hidden fixed bottom-20 right-4 bg-white p-2 rounded shadow w-64">
    <div class="w-full bg-gray-200 rounded h-4">
      <div id="progressBar" class="bg-blue-600 h-4 rounded" style="width:0%"></div>
    </div>
  </div>
</div>

<div id="status">ğŸŸ¡ æ­£åœ¨åŒæ­¥...</div>

<!-- å›¾ç‰‡/è§†é¢‘é¢„è§ˆ -->
<div id="previewModal" class="hidden">
  <div id="previewContent"></div>
</div>

<script>
  let isAdmin = false;
  let currentUser = "";

  const loginPage = document.getElementById('loginPage');
  const mainPage = document.getElementById('mainPage');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const contentArea = document.getElementById('contentArea');
  const statusEl = document.getElementById('status');
  const usernameEl = document.getElementById('username');
  const adminPassDiv = document.getElementById('adminPassDiv');
  const adminPassEl = document.getElementById('adminPass');
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const previewModal = document.getElementById('previewModal');
  const previewContent = document.getElementById('previewContent');
  const newNewsBtn = document.getElementById('newNews');

  usernameEl.addEventListener('input', () => {
    if (usernameEl.value.trim() === "guangminghui") {
      adminPassDiv.classList.remove('hidden');
    } else {
      adminPassDiv.classList.add('hidden');
    }
  });

  loginBtn.addEventListener('click', () => {
    const username = usernameEl.value.trim();
    if (!username) { alert("è¯·è¾“å…¥åå­—"); return; }
    if (username === "guangminghui") {
      if (adminPassEl.value !== "guangminghui888") {
        alert("ç®¡ç†å‘˜å¯†ç é”™è¯¯");
        return;
      }
      isAdmin = true;
      newNewsBtn.classList.remove('hidden'); // ç®¡ç†å‘˜æ‰èƒ½å‘å¸ƒæ–°é—»
    } else {
      isAdmin = false;
      newNewsBtn.classList.add('hidden'); // å®¢æˆ·éšè—æŒ‰é’®
    }
    currentUser = username;
    loginPage.classList.add('hidden');
    mainPage.classList.remove('hidden');
    syncData();
  });

  logoutBtn.addEventListener('click', () => {
    mainPage.classList.add('hidden');
    loginPage.classList.remove('hidden');
    isAdmin = false;
    currentUser = "";
  });

  async function syncData() {
    try {
      statusEl.textContent = "ğŸŸ¡ æ­£åœ¨åŒæ­¥...";
      const res = await fetch('/data');
      const data = await res.json();
      render(data);
      statusEl.textContent = "ğŸŸ¢ å·²åŒæ­¥";
    } catch (e) {
      statusEl.textContent = "ğŸ”´ åŒæ­¥å¤±è´¥";
    }
    setTimeout(syncData, 3000);
  }

  function render(data) {
    contentArea.innerHTML = '';
    [...data.news, ...data.wishes].forEach(item => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <h3 class="font-bold mb-2">${item.type === 'news' ? 'æ–°é—»' : 'æ„¿æœ›'}</h3>
        <p>${item.text || ''}</p>
        ${item.file ? `<img src="${item.file}" class="mt-2 cursor-pointer" onclick="showPreview('${item.file}', 'image')"/>` : ''}
        <div class="flex items-center space-x-2 mt-2">
          <span class="like text-red-500">â¤ï¸</span>
          <input class="border flex-1 p-1 rounded comment" placeholder="å†™è¯„è®º..."/>
        </div>
      `;
      if (isAdmin) {
        const del = document.createElement('button');
        del.textContent = "åˆ é™¤";
        del.className = "bg-red-500 text-white px-2 py-1 mt-2 rounded";
        del.onclick = async () => {
          await fetch('/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: item.type, id: item.id, adminName: 'guangminghui', adminPass: 'guangminghui888' })
          });
        };
        div.appendChild(del);
      }
      contentArea.appendChild(div);
    });

    document.querySelectorAll('.like').forEach(el => {
      el.addEventListener('click', () => el.classList.toggle('opacity-50'));
    });
    document.querySelectorAll('.comment').forEach(input => {
      input.addEventListener('keypress', e => {
        if (e.key === 'Enter' && input.value.trim()) {
          alert(`è¯„è®º: ${input.value}`);
          input.value = '';
        }
      });
    });
  }

  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => handleUpload(fileInput.files[0]));

  async function handleUpload(file) {
    if (!file) return;
    progressContainer.classList.remove('hidden');
    const formData = new FormData();
    formData.append('file', file);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload', true);
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const percent = (e.loaded / e.total) * 100;
        progressBar.style.width = percent + '%';
      }
    };
    xhr.onload = () => {
      progressContainer.classList.add('hidden');
      progressBar.style.width = '0%';
      alert('ä¸Šä¼ å®Œæˆ');
    };
    xhr.send(formData);
  }

  window.showPreview = (src, type) => {
    previewModal.classList.remove('hidden');
    previewContent.innerHTML = type === 'image'
      ? `<img src="${src}"/>`
      : `<video src="${src}" controls autoplay></video>`;
  };
  previewModal.addEventListener('click', () => previewModal.classList.add('hidden'));
</script>

</body>
</html>
