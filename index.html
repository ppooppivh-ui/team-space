<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å›¢é˜Ÿæ–°é—»ç©ºé—´ï¼ˆAll-in-Oneï¼‰</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
body{background:linear-gradient(135deg,#e6f0ff,#f6f0ff);min-height:100vh}
.glass{background:rgba(255,255,255,0.95);backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(2,6,23,0.06);border-radius:12px;padding:12px}
.content-card{transition:all .22s ease}
.content-card:hover{transform:translateY(-8px);box-shadow:0 18px 48px rgba(2,6,23,0.08)}
.like-anim{animation:heartbeat .45s ease}
@keyframes heartbeat{0%{transform:scale(1)}30%{transform:scale(1.28)}60%{transform:scale(.92)}100%{transform:scale(1)}}
.small-muted{font-size:12px;color:#6b7280}
#syncDot{font-size:18px}
#uploadProgress{height:8px;border-radius:6px;background:#eee;overflow:hidden}
#uploadBar{height:100%;width:0%}
</style>
</head>
<body>
<nav class="glass sticky top-3 container mx-auto px-4 py-3 flex justify-between items-center">
  <div class="flex items-center gap-3"><i class="bi bi-newspaper text-3xl text-indigo-600"></i><h1 class="text-xl font-semibold">å›¢é˜Ÿæ–°é—»ç©ºé—´</h1></div>
  <div><span id="syncDot">ğŸŸ¢</span></div>
</nav>

<div class="container mx-auto px-4 py-6">
  <!-- login -->
  <div id="loginBox" class="max-w-md mx-auto glass">
    <h2 class="text-2xl font-bold mb-3">ç™»å½•</h2>
    <div class="space-y-2">
      <input id="nameInput" placeholder="è¯·è¾“å…¥å§“å" class="w-full border rounded p-2" oninput="onNameChange()" />
      <input id="adminPwd" placeholder="ç®¡ç†å‘˜å¯†ç " type="password" class="w-full border rounded p-2 hidden" />
      <div class="flex gap-2">
        <button class="bg-indigo-600 text-white px-3 py-2 rounded" onclick="doLogin()">è¿›å…¥</button>
        <button class="border px-3 py-2 rounded" onclick="fillDemo()">ç¤ºä¾‹æ•°æ®</button>
      </div>
      <p class="small-muted">è¯´æ˜ï¼šæ™®é€šç”¨æˆ·åªéœ€è¾“å…¥å§“åï¼›ç®¡ç†å‘˜è¯·åœ¨å§“åå¡«å†™ <code>admin</code> åè¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼ˆéšè—æ¡†åªåœ¨è¾“å…¥ admin æ—¶å‡ºç°ï¼‰ã€‚</p>
    </div>
  </div>

  <!-- main -->
  <div id="mainBox" class="hidden space-y-4">
    <div class="flex gap-3 items-center">
      <div class="flex gap-2">
        <button onclick="showTab('news')" id="tabNews" class="bg-indigo-600 text-white px-3 py-1 rounded">æ–°é—»</button>
        <button onclick="showTab('media')" id="tabMedia" class="px-3 py-1 rounded">åª’ä½“</button>
        <button onclick="showTab('wishes')" id="tabWishes" class="px-3 py-1 rounded">æ„¿æœ›æ± </button>
        <button onclick="showTab('admin')" id="tabAdmin" class="px-3 py-1 rounded hidden">åå°</button>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button onclick="manualSync()" class="bg-yellow-400 px-3 py-1 rounded">æ‰‹åŠ¨åŒæ­¥</button>
        <button onclick="forceReload()" class="border px-3 py-1 rounded">é‡æ–°åŠ è½½</button>
      </div>
    </div>

    <!-- news -->
    <div id="newsPane">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="newsGrid"></div>
    </div>

    <!-- media -->
    <div id="mediaPane" class="hidden">
      <div class="glass p-3 mb-4">
        <div class="flex items-center gap-2">
          <input type="file" id="mediaFile" accept="image/*,video/*"/>
          <button class="bg-green-600 text-white px-3 py-2 rounded" onclick="uploadMedia()">ä¸Šä¼ åª’ä½“</button>
          <div id="uploadProgress" class="w-1/3 hidden"><div id="uploadBar" style="width:0%"></div></div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="mediaGrid"></div>
    </div>

    <!-- wishes -->
    <div id="wishesPane" class="hidden">
      <div class="glass p-3">
        <textarea id="wishText" rows="3" class="w-full border rounded p-2" placeholder="å†™ä¸‹ä½ çš„æ„¿æœ›..."></textarea>
        <div class="flex items-center gap-2 mt-2">
          <label><input type="radio" name="wishPrivacy" value="public" checked/> å…¬å¼€</label>
          <label><input type="radio" name="wishPrivacy" value="anonymous"/> åŒ¿å</label>
          <button class="ml-auto bg-indigo-600 text-white px-3 py-1 rounded" onclick="submitWish()">æäº¤æ„¿æœ›</button>
        </div>
      </div>
      <div id="wishList" class="mt-3 space-y-2"></div>
    </div>

    <!-- admin -->
    <div id="adminPane" class="hidden">
      <div class="glass p-3 space-y-2">
        <h3 class="font-semibold">å‘å¸ƒæ–°é—»</h3>
        <input id="newsTitle" class="w-full border rounded p-2" placeholder="æ ‡é¢˜"/>
        <textarea id="newsBody" class="w-full border rounded p-2" placeholder="å†…å®¹"></textarea>
        <input type="file" id="newsImage" accept="image/*"/>
        <div class="flex gap-2">
          <button class="bg-green-600 text-white px-3 py-1 rounded" onclick="uploadNews()">ä¸Šä¼ æ–°é—»</button>
          <button class="border px-3 py-1 rounded" onclick="renderAdminLists()">åˆ·æ–°ç®¡ç†åˆ—è¡¨</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="glass p-3">
          <h4 class="font-semibold">åœ¨çº¿ç”¨æˆ·</h4>
          <div id="onlineList" class="mt-2 space-y-1"></div>
        </div>
        <div class="glass p-3">
          <h4 class="font-semibold">ç®¡ç†åˆ—è¡¨ï¼ˆæ–°é—»/åª’ä½“/æ„¿æœ›ï¼‰</h4>
          <div id="adminLists" class="mt-2 space-y-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- viewer modal -->
<div id="viewerModal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black/50" onclick="closeViewer()"></div>
  <div class="relative bg-white rounded p-4 z-60 w-11/12 md:w-3/4 lg:w-1/2 max-h-[85vh] overflow-auto">
    <button class="absolute right-3 top-3" onclick="closeViewer()"><i class="bi bi-x-lg text-2xl"></i></button>
    <div id="viewerContent"></div>
    <div class="mt-3 flex items-center gap-2">
      <button id="likeBtn" class="bg-red-500 text-white px-3 py-1 rounded" onclick="toggleLike()"><i id="likeIcon" class="bi bi-heart"></i> <span id="likeCount">0</span></button>
      <input id="commentInput" class="flex-1 border rounded p-2" placeholder="å†™è¯„è®ºï¼Œå›è½¦æäº¤" onkeydown="if(event.key==='Enter'){submitComment();}"/>
      <button class="bg-indigo-600 text-white px-3 py-1 rounded" onclick="submitComment()">æäº¤</button>
    </div>
    <div id="commentList" class="mt-3 space-y-2"></div>
  </div>
</div>

<script>
/* Config */
const API_BASE = ''; // same origin
const POLL_MS = 3000;
const MAX_FILE = 100 * 1024 * 1024;
const IMG_MAX_EDGE = 1920;
const IMG_QUALITY = 0.8;

let currentUser = '';
let isAdmin = false;
let lastUpdate = 0;
let currentContent = null;

/* Helpers */
function el(id){ return document.getElementById(id); }
function showToast(msg){ alert(msg); }

/* Login behavior: show admin password input only when name === 'admin' */
function onNameChange(){
  const v = el('nameInput').value.trim();
  if(v.toLowerCase() === 'admin') el('adminPwd').classList.remove('hidden'); else el('adminPwd').classList.add('hidden');
}

async function doLogin(){
  const name = el('nameInput').value.trim();
  if(!name) return showToast('è¯·è¾“å…¥å§“å');
  const pwd = el('adminPwd').value || '';
  if(name.toLowerCase() === 'admin'){
    // call login API to verify password
    try{
      const res = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name:'admin', password: pwd})});
      if(!res.ok) throw new Error('admin fail');
      const j = await res.json();
      currentUser = 'admin'; isAdmin = true;
    }catch(e){ showToast('ç®¡ç†å‘˜å¯†ç é”™è¯¯'); return; }
  } else {
    // register/check name
    await fetch('/api/register', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})});
    currentUser = name; isAdmin = false;
  }
  // enter main UI
  el('loginBox').classList.add('hidden'); el('mainBox').classList.remove('hidden');
  if(isAdmin) el('tabAdmin').classList.remove('hidden'); else el('tabAdmin').classList.add('hidden');
  el('syncDot').textContent = 'ğŸŸ¡';
  sendHeartbeat();
  fetchState(); setInterval(fetchState, POLL_MS);
}

/* Sync */
async function fetchState(){
  try{
    const res = await fetch('/api/state?since=' + lastUpdate);
    if(!res.ok) throw new Error('state fail');
    const j = await res.json();
    if(j.updated){
      lastUpdate = j.lastUpdate;
      applyState(j.data);
    }
    el('syncDot').textContent = 'ğŸŸ¢';
  }catch(e){ el('syncDot').textContent = 'ğŸ”´'; console.error(e); }
}

function applyState(data){
  renderNews(data.news || []);
  renderMedia(data.media || []);
  renderWishes(data.wishes || []);
  renderOnline(data.online || {});
}

/* Renderers */
function renderNews(news){
  const grid = el('newsGrid'); grid.innerHTML='';
  news.forEach(n=>{
    const card = document.createElement('div'); card.className='glass content-card rounded p-3 cursor-pointer';
    card.innerHTML = `<h3 class="font-semibold">${escapeHtml(n.title)}</h3><p class="small-muted">${escapeHtml(n.author)} Â· ${escapeHtml(n.time)}</p><p class="mt-2 text-sm line-clamp-3">${escapeHtml(n.body)}</p>`;
    card.onclick = ()=> openViewer('news', n.id, n);
    grid.appendChild(card);
  });
}

function renderMedia(media){
  const grid = el('mediaGrid'); grid.innerHTML='';
  media.forEach(m=>{
    const d = document.createElement('div'); d.className='glass content-card rounded p-2 cursor-pointer';
    if(m.type && m.type.startsWith('image')) d.innerHTML = `<img src="${m.url}" class="rounded w-full" alt="${escapeHtml(m.filename||'')}"/>`;
    else d.innerHTML = `<div class="relative"><video src="${m.url}" class="rounded w-full" muted playsinline></video><div class="absolute inset-0 flex items-center justify-center pointer-events-none"><i class="bi bi-play-circle-fill text-6xl text-white/80"></i></div></div>`;
    d.onclick = ()=> openViewer('media', m.id, m);
    grid.appendChild(d);
  });
}

function renderWishes(wishes){
  const box = el('wishList'); box.innerHTML='';
  wishes.forEach(w=>{
    const d = document.createElement('div'); d.className='p-3 bg-white rounded';
    d.innerHTML = `<div class="flex justify-between"><strong>${escapeHtml(w.author)}</strong><span class="small-muted">${escapeHtml(w.time)}</span></div><p class="mt-2">${escapeHtml(w.text)}</p>`;
    box.appendChild(d);
  });
}

function renderOnline(online){
  const eln = el('onlineList'); if(!eln) return; eln.innerHTML='';
  Object.keys(online||{}).forEach(k=>{
    const it = document.createElement('div'); it.className='p-2 border rounded'; it.textContent = `${k} Â· ${new Date(online[k].last).toLocaleString()}`; eln.appendChild(it);
  });
}

/* Viewer, comments, likes */
function openViewer(type,id,item){
  currentContent = { type, id };
  const vc = el('viewerContent'); vc.innerHTML='';
  if(type==='news') vc.innerHTML = `<h2 class="text-xl font-semibold">${escapeHtml(item.title)}</h2>${item.img?`<img src="${item.img}" class="mt-2 rounded w-full"/>`:''}<p class="mt-3">${escapeHtml(item.body)}</p><p class="small-muted mt-2">ä½œè€…:${escapeHtml(item.author)} Â· ${escapeHtml(item.time)}</p>`;
  else vc.innerHTML = (item.type && item.type.startsWith('image'))?`<img src="${item.url}" class="w-full rounded"/>`:`<video src="${item.url}" controls class="w-full rounded"></video>`;
  loadLikes(type,id); loadComments(type,id);
  el('viewerModal').classList.remove('hidden');
}
function closeViewer(){ el('viewerModal').classList.add('hidden'); el('commentList').innerHTML=''; el('commentInput').value=''; currentContent=null; }

async function loadLikes(type,id){
  const res = await fetch('/api/state'); const j = await res.json(); const key = type + '_' + id; const info = (j.data && j.data.likes && j.data.likes[key])||{count:0,users:[]}; el('likeCount').textContent = info.count || 0; el('likeIcon').className = (info.users||[]).includes(currentUser)?'bi bi-heart-fill':'bi bi-heart';
}
async function toggleLike(){ if(!currentUser||!currentContent) return showToast('è¯·å…ˆç™»å½•'); const key = currentContent.type + '_' + currentContent.id; await fetch('/api/like',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key,user:currentUser})}); fetchState(); loadLikes(currentContent.type,currentContent.id); }

async function loadComments(type,id){ const res = await fetch('/api/state'); const j = await res.json(); const key = type + '_' + id; const arr = (j.data && j.data.comments && j.data.comments[key])||[]; const elc = el('commentList'); elc.innerHTML=''; arr.forEach(c=>{ const d = document.createElement('div'); d.className='p-2 border rounded'; d.innerHTML = `<strong>${escapeHtml(c.author)}</strong><div>${escapeHtml(c.text)}</div><div class="small-muted">${escapeHtml(c.time)}</div>`; elc.appendChild(d); }); }
async function submitComment(){ if(!currentUser||!currentContent) return showToast('è¯·å…ˆç™»å½•'); const text = el('commentInput').value.trim(); if(!text) return; await fetch('/api/comment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key: currentContent.type+'_'+currentContent.id, author: currentUser, text})}); el('commentInput').value=''; loadComments(currentContent.type,currentContent.id); fetchState(); }

/* Uploads: compress images and upload with progress */
function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
function compressImage(file, maxEdge, quality){ return new Promise((resolve)=>{ const img=new Image(); const fr=new FileReader(); fr.onload=function(e){ img.onload=function(){ let w=img.width,h=img.height; if(Math.max(w,h)>maxEdge){ const r=maxEdge/Math.max(w,h); w=Math.round(w*r); h=Math.round(h*r);} const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); c.toBlob((blob)=>{ if(!blob) return resolve(file); const newFile = new File([blob], file.name.replace(/\.[^/.]+$/,'')+'.jpg', { type:'image/jpeg' }); resolve(newFile); }, 'image/jpeg', quality); }; img.onerror=()=>resolve(file); img.src=e.target.result; }; fr.readAsDataURL(file); }); }

async function uploadMedia(){ const file = el('mediaFile').files[0]; if(!file) return showToast('è¯·é€‰æ‹©æ–‡ä»¶'); if(file.size>MAX_FILE) return showToast('æ–‡ä»¶è¶…è¿‡é™åˆ¶'); let toSend = file; if(file.type.startsWith('image/')) toSend = await compressImage(file, IMG_MAX_EDGE, IMG_QUALITY); const form = new FormData(); form.append('author', currentUser); form.append('media', toSend, file.name); const xhr = new XMLHttpRequest(); xhr.open('POST','/api/media',true); xhr.upload.onprogress = (e)=>{ if(e.lengthComputable){ const pct=Math.round(e.loaded/e.total*100); el('uploadProgress').classList.remove('hidden'); el('uploadBar').style.width = pct + '%'; } }; xhr.onload = ()=>{ el('uploadProgress').classList.add('hidden'); el('uploadBar').style.width='0%'; if(xhr.status===200) { showToast('ä¸Šä¼ æˆåŠŸ'); fetchState(); } else showToast('ä¸Šä¼ å¤±è´¥'); }; xhr.onerror = ()=>showToast('ä¸Šä¼ é”™è¯¯'); xhr.send(form); }

async function uploadNews(){ const title = el('newsTitle').value.trim(); const body = el('newsBody').value.trim(); const file = el('newsImage').files[0]; if(!title||!body) return showToast('è¯·è¾“å…¥æ ‡é¢˜å’Œå†…å®¹'); const form = new FormData(); form.append('title', title); form.append('body', body); form.append('author', currentUser); if(file){ let toSend = file; if(file.type.startsWith('image/')) toSend = await compressImage(file, IMG_MAX_EDGE, IMG_QUALITY); form.append('image', toSend, file.name); } const res = await fetch('/api/news',{method:'POST', body: form}); if(res.ok){ showToast('æ–°é—»ä¸Šä¼ æˆåŠŸ'); fetchState(); el('newsTitle').value=''; el('newsBody').value=''; el('newsImage').value=''; } else showToast('ä¸Šä¼ å¤±è´¥'); }

async function submitWish(){ const text = el('wishText').value.trim(); const priv = document.querySelector('input[name=\"wishPrivacy\"]:checked').value; if(!text) return showToast('è¯·è¾“å…¥æ„¿æœ›'); await fetch('/api/wish',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,privacy:priv,author: currentUser})}); el('wishText').value=''; fetchState(); showToast('æ„¿æœ›å·²æäº¤'); }

/* likes/comments handled above */

/* Admin delete */
async function adminDelete(type,id){ if(!isAdmin) return showToast('ä»…ç®¡ç†å‘˜å¯åˆ é™¤'); await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,id,admin:true})}); fetchState(); renderAdminLists(); showToast('å·²åˆ é™¤'); }
function renderAdminLists(){ const box = el('adminLists'); box.innerHTML=''; fetch('/api/state').then(r=>r.json()).then(j=>{ const data = j.data; (data.news||[]).forEach(n=>{ const row = document.createElement('div'); row.className='p-2 border rounded flex justify-between items-center'; row.innerHTML = `<div><strong>${escapeHtml(n.title)}</strong><div class='small-muted'>${escapeHtml(n.author)} Â· ${escapeHtml(n.time)}</div></div><div class='flex gap-2'><button class='text-red-500' onclick='adminDelete(\"news\", ${n.id})'>åˆ é™¤</button></div>`; box.appendChild(row); }); (data.media||[]).forEach(m=>{ const row = document.createElement('div'); row.className='p-2 border rounded flex justify-between items-center'; row.innerHTML = `<div><strong>${escapeHtml(m.filename||m.url)}</strong><div class='small-muted'>${escapeHtml(m.author)} Â· ${escapeHtml(m.time)} Â· ${formatBytes(m.size||0)}</div></div><div><button class='text-red-500' onclick='adminDelete(\"media\", ${m.id})'>åˆ é™¤</button></div>`; box.appendChild(row); }); (data.wishes||[]).forEach(w=>{ const row = document.createElement('div'); row.className='p-2 border rounded flex justify-between items-center'; row.innerHTML = `<div><strong>${escapeHtml(w.author)}</strong><div class='small-muted'>${escapeHtml(w.text)}</div></div><div><button class='text-red-500' onclick='adminDelete(\"wish\", ${w.id})'>åˆ é™¤</button></div>`; box.appendChild(row); }); }); }

/* Heartbeat */
function sendHeartbeat(){ fetch('/api/heartbeat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name: currentUser, deviceId: localStorage.getItem('device_id')||null})}).catch(()=>{}); }
setInterval(()=>{ if(currentUser) sendHeartbeat(); }, 5000);

/* Utility */
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatBytes(b){ if(!b) return '0 B'; const units=['B','KB','MB','GB']; let u=0; while(b>=1024&&u<units.length-1){ b/=1024; u++; } return b.toFixed(2)+' '+units[u]; }

/* Comment and like helpers are above */

/* Submit comment and loadComments */
async function loadComments(type,id){ const res = await fetch('/api/state'); const j = await res.json(); const key = type + '_' + id; const arr = (j.data && j.data.comments && j.data.comments[key])||[]; const elc = el('commentList'); elc.innerHTML=''; arr.forEach(c=>{ const d=document.createElement('div'); d.className='p-2 border rounded'; d.innerHTML = `<strong>${escapeHtml(c.author)}</strong><div>${escapeHtml(c.text)}</div><div class='small-muted'>${escapeHtml(c.time)}</div>`; elc.appendChild(d); }); }
async function submitComment(){ if(!currentUser||!currentContent) return showToast('è¯·å…ˆç™»å½•'); const text = el('commentInput').value.trim(); if(!text) return; await fetch('/api/comment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key: currentContent.type+'_'+currentContent.id, author: currentUser, text})}); el('commentInput').value=''; loadComments(currentContent.type,currentContent.id); fetchState(); }

/* Misc UI and init */
function showTab(t){ ['news','media','wishes','admin'].forEach(x=>{ el(x+'Pane').classList.add('hidden'); el('tab'+capitalize(x)).classList.remove('bg-indigo-600','text-white'); }); el(t+'Pane').classList.remove('hidden'); el('tab'+capitalize(t)).classList.add('bg-indigo-600','text-white'); }
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* Demo data filler */
async function fillDemo(){ await fetch('/api/wish',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:'å¸Œæœ›é¡¹ç›®é¡ºåˆ©ä¸Šçº¿',privacy:'public',author:'ç³»ç»Ÿ'})}); await fetch('/api/news',{method:'POST', body: new FormData()}); fetchState(); }

/* Startup */
if(!localStorage.getItem('device_id')) localStorage.setItem('device_id','dev_'+Math.random().toString(36).slice(2,10));
</script>
</body>
</html>
